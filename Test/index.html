<html>
<head>

    <!-- jQuery and jQuery Mobile -->
    <script src="lib/jquery-2.0.2.min.js"></script>
    <script src="lib/jquery.mobile-1.4.2.min.js"></script>
    <link rel="stylesheet" href="css/jquery.mobile-1.4.2.min.css">
    <link rel="stylesheet" href="css/GolfTheme.min.css" />

    <!-- Golf style and jQuery -->
    <link rel="stylesheet" href="css/golfStyle.css">
   <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/PushNotification.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
        app.initialize();
    </script>
    <script type="text/javascript" src="js/main.js"></script>
    <title></title>
</head>
<body>

    <div data-role="page" id="page1">
        <div style="text-align: center;">
            <img class="logo" src="images/logo.png">
        </div>

        <div class="ui-content">
            <label>
                Username
            </label>
            <input id="username" type="text">

            <label>
                Password
            </label>
            <input id="password" type="password">

            <br />
            <button id="login" class="btnClick" data-mini="true" data-theme="c">Login
            </button>

        </div>
    </div>
    <div class="app">
        <div id="deviceready" class="blink">
            <p class="event listening"></p>
            <p class="event received"></p>
        </div>
    </div>

</body>
</html>
<script type="text/javascript">
    
        
    $(document).one('pagecreate', function () {

        $.ajaxSetup({
            error: function (jqXHR, exception) {
                if (jqXHR.status === 0) {
                    alert('Not connect.\n Verify Network.');
                } else if (jqXHR.status == 404) {
                    alert('Requested page not found. [404]');
                
                } else if (jqXHR.status == 500) {
                    alert('Internal Server Error [500].');
                } else if (exception === 'parsererror') {
                    alert('Requested JSON parse failed.');
                } else if (exception === 'timeout') {
                    alert('Time out error.');
                } else if (exception === 'abort') {
                    alert('Ajax request aborted.');
                } else {
                  //  alert('Uncaught Error.\n' + jqXHR.responseText);
                   
                }
            }
        });

        function navigateToMenu() {
            $.mobile.changePage("booking_menu.html", {
                transition: "flip",
                reverse: false,
                changeHash: false
            });

           // $.mobile.navigate("booking_menu.html");
        }


        if (localStorage.getItem("UserName") != undefined && localStorage.getItem("Token") != undefined) {

           
            navigateToMenu();

            $.ajaxSetup({
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("Token")
                }
            });


        }

        $("#login").click(function () {
            login($("#username").val(), $("#password").val());
        });

        function login(username, password) {
            $.ajax({
                type: "POST",
                url: URL_API + "/token",
                async: false,
                contentType: "application/x-www-form-urlencoded",
                data: "grant_type=password&username=" + username + "&password=" + password
            })
           .done(function (data) {

              // alert("sucess");

               localStorage.setItem("Token", data.access_token);
               localStorage.setItem("UserName", data.userName);

               var isLogin = authenticate(data);
         

               //if (isLogin) {
               //    alert("login");
               //    navigateToMenu();

               //    localStorage.setItem("Token", data.access_token);
               //    localStorage.setItem("UserName", data.userName);

               //} else {
               //    alert("Invalid login 2");
               //}

            
           }).fail(function () {
               alert("Invalid login");

           });
        }


        function getDeviceID() {

            if (localStorage.getItem("DeviceKey") != null) {
                return localStorage.getItem("DeviceKey");
            } else {
                return "no-device-id";
            }

        }

        function authenticate(msg) {

            var IsAuthenticated = false;
            //alert(msg.access_token);
            var token = {
                DeviceKey: getDeviceID(),
                Token: msg.access_token,
                TokenExpiryDate: msg.expires_in,
                UserName: msg.userName
            };


            $.ajax({
                type: "POST",
                url: URL_API + "/api/User/Authenticate",
                contentType: "application/json",
                async: true,
                data: JSON.stringify(token),
                headers: {
                    "Authorization": "Bearer " + msg.access_token
                }
            }).done(function (data) {

                var msg = JSON.parse(data);

                localStorage.setItem("ICNo", msg.ICNo);
                localStorage.setItem("Email", msg.Email);
                localStorage.setItem("UserID", msg.UserID);
                localStorage.setItem("ClubMemberID", msg.ClubMemberID);
                localStorage.setItem("MembershipNo", msg.MembershipNo);
                IsAuthenticated = true;
                // alert(msg.ICNo);
                navigateToMenu();
            }).fail(function () {
                IsAuthenticated = false;
                // alert("fail authenticate");

                if (localStorage.getItem("UserName") != undefined) {
                    $("#login").click();
                }



            });

            return IsAuthenticated;
        }


    });


    
</script>

