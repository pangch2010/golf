<html>
<head>
    <!-- jQuery and jQuery Mobile -->
    <script src="lib/jquery-2.0.2.min.js"></script>
    <script src="lib/jquery.mobile-1.4.2.min.js"></script>
    <link rel="stylesheet" href="css/jquery.mobile-1.4.2.min.css">
    <link rel="stylesheet" href="css/GolfTheme.min.css" />

    <!-- Golf style and jQuery -->
    <link rel="stylesheet" href="css/golfStyle.css">

    <title></title>
</head>
<body>
    <div data-role="page" id="page1">


        <div data-role="content">

            <a data-role="button" href="index.html" data-icon="minus" class="btnRight ui-btn-right" data-transition="flip" data-theme="c" onclick="clearLocalStorage();" rel="external">Logout</a>
            <a data-role="button" href="booking_menu.html" data-icon="grid" class="btnLeft ui-btn-left" data-transition="slide" data-theme="c" data-direction="reverse" rel="external">Menu</a>

            <script>
                function clearLocalStorage() {
                    return localStorage.clear();
                }
            </script>

            <br />
            <br />

            <ul data-role="listview" data-theme="a" data-inset="true">
                <li data-theme="g">
                    <label>New Booking</label>
                </li>
                <li data-theme="d">
                    <select data-theme="d" id="dropClub">

                        <option value="option1">KLGCC
                        </option>

                    </select>
                    <!--                </li>
                <li data-theme="d">-->
                    <select data-theme="d" id="dropCourse">
                        <!--                          <option>- - - Please Select Golf Course - - -</option>-->
                        <option value="option1">East Course 1
                        </option>
                        <option value="option2">East Course 2
                        </option>
                        <option value="option3">West Course
                        </option>

                    </select>
                </li>

                <li data-theme="d">
                    <div id="bookingTable" class="ui-grid-d slot">

                        <div class="ui-block-a bookingHeader">
                            Day
                        </div>
                        <div class="ui-block-b bookingHeader">
                            Date
                        </div>
                        <div class="ui-block-c bookingHeader">
                            Morning
                            <!--<img src="images/morning.png" alt="morning" />-->
                        </div>
                        <div class="ui-block-d bookingHeader">
                            Afternoon
                            <!--<img src="images/afternoon.png" alt="Afternoon" />-->
                        </div>
                        <div class="ui-block-e bookingHeader">
                            Night
                            <!--<img src="images/night.png" alt="Night" />-->
                        </div>

                    </div>
                </li>
            </ul>

        </div>


        <script type="text/javascript">
            //UserSelected
            var TimeSelected = "";
            var DateSelected = "";
            var SessionSelected = "";
            var CourseSelected = "";
            var ClubSelected = "";
            var HoleSelected = "";
            var ServerEndpointAPI = "https://175.139.183.94:76/GolfAPI/";
            //var ServerEndpointAPI = "http://localhost:3998/";
            //getfrom Server
            var INTERVAL;
            var START_TIME;
            var END_TIME;

            var DAY_9HOLE;;
            var NIGHT_9HOLE;

            var BookedData = new Array();
            var totalpopulate;

            $(document).ready(function () {
                var nowDate = new Date();
                var weekday = new Array(7);
                weekday[0] = "SUN";
                weekday[1] = "MON";
                weekday[2] = "TUE";
                weekday[3] = "WED";
                weekday[4] = "THU";
                weekday[5] = "FRI";
                weekday[6] = "SAT";

                var monthName = new Array(12);
                monthName[0] = "January";
                monthName[1] = "February";
                monthName[2] = "March";
                monthName[3] = "April";
                monthName[4] = "May";
                monthName[5] = "June";
                monthName[6] = "July";
                monthName[7] = "August";
                monthName[8] = "September";
                monthName[9] = "October";
                monthName[10] = "November";
                monthName[11] = "December";

                var month = new Array(14);

                for (var i = 0; i < 14; i++) {
                    var addDate = new Date();
                    addDate.setDate(addDate.getDate() + i);

                    var displayDate = new Date(addDate);
                    var day = weekday[displayDate.getDay()];


                    month[i] = monthName[displayDate.getMonth()];

                    var date = displayDate.getFullYear() + "-" + (displayDate.getMonth() + 1) + "-" + displayDate.getDate();

                    if (i == 0 || month[i] != month[i - 1]) {
                        $("#bookingTable").append("<div class=" + 'ui-block-a' + "></div>").children().last().trigger("create");
                        $("#bookingTable").append("<div class=" + 'ui-block-b' + ">" + month[i] + " " + displayDate.getFullYear() + "</div>").children().last().trigger("create");
                        //$("#bookingTable").append("<div class=" + 'ui-block-b' + "> <a data-role=" + 'button' + " data-corners=" + 'false' + " class=" + 'ui-disabled' + ">" + month[i] + "</a></div>").children().last().trigger("create");
                        $("#bookingTable").append("<div class=" + 'ui-block-c' + "></div>").children().last().trigger("create");
                        $("#bookingTable").append("<div class=" + 'ui-block-d' + "></div>").children().last().trigger("create");
                        $("#bookingTable").append("<div class=" + 'ui-block-e' + "></div>").children().last().trigger("create");
                    }

                    //$("#bookingTable").append("<div class=" + 'ui-block-a' + "> <a data-role=" + 'button' + " data-theme=" + 'a' + " data-corners=" + 'false' + " class=" + 'ui-disabled' + ">" + day + "</a></div>").children().last().trigger("create");
                    $("#bookingTable").append("<div class=" + 'ui-block-a' + ">" + day + "</div>").children().last().trigger("create");
                    $("#bookingTable").append("<div class=" + 'ui-block-b' + ">" + displayDate.getDate() + "</div>").children().last().trigger("create");
                    //$("#bookingTable").append("<div class=" + 'ui-block-b' + "> <a data-role=" + 'button' + " data-theme=" + 'a' + " data-corners=" + 'false' + " class=" + 'ui-disabled' + ">" + displayDate.getDate() + "</a></div>").children().last().trigger("create");
                    $("#bookingTable").append("<div class=" + 'ui-block-c' + "> <a id=" + "Morning|" + date + " href=" + '#popup_Booking' + " data-rel=" + 'popup' + " data-role=" + 'button' + " data-theme=" + 'g' + " data-corners=" + 'false' + ">" + "<img src=" + 'images/morning.png' + " alt=" + 'morning' + " />" + "</a></div>").children().last().trigger("create");
                    $("#bookingTable").append("<div class=" + 'ui-block-d' + "> <a id=" + "Afternoon|" + date + " href=" + '#popup_Booking' + " data-rel=" + 'popup' + " data-role=" + 'button' + " data-theme=" + 'g' + " data-corners=" + 'false' + ">" + "<img src=" + 'images/afternoon.png' + " alt=" + 'Afternoon' + " />" + "</a></div>").children().last().trigger("create");
                    $("#bookingTable").append("<div class=" + 'ui-block-e' + "> <a id=" + "Night|" + date + " href=" + '#popup_Booking' + " data-rel=" + 'popup' + " data-role=" + 'button' + " data-theme=" + 'g' + " data-corners=" + 'false' + ">" + "<img src=" + 'images/night.png' + " alt=" + 'Night' + " />" + "</a></div>").children().last().trigger("create");

                }
                $(".ui-block-a").addClass("bookingContent");
                $(".ui-block-b").addClass("bookingContent");
                $(".ui-block-a").first().removeClass("bookingContent");
                $(".ui-block-b").first().removeClass("bookingContent")

                $("a[data-role=button]").click(function () {
                    var value = $(this).attr("id");
                    var strSplit = value.split("|");
                    var course = $('#dropCourse :selected').text();
                    var club = $('#dropClub :selected').text();

                    $("#Inside-DateTime").html("");
                    $("#Inside-DateTime").append(strSplit[1] + " [ " + strSplit[0] + " ]");
                    $("#Inside-Course").html("");
                    $("#Inside-Course").append(course);
                    $("#Inside-Club").html("");
                    $("#Inside-Club").append(club);



                    DateSelected = strSplit[1];
                    SessionSelected = strSplit[0];
                    CourseSelected = course;
                    ClubSelected = club;

                    //done by Pang 
                    //ajax get from database

                    var Type = "";
                    if (SessionSelected == "Morning") {
                        Type = "AM";
                    } else if (SessionSelected == "Afternoon") {
                        Type = "PM";

                    } else if (SessionSelected == "Night") {
                        Type = "NIGHT";

                    }

                    $.ajax({
                        url: ServerEndpointAPI + 'api/TimeSlot/settings',
                        type: 'GET',
                        dataType: 'json',
                        data: {
                            CourseCode: "EST2",
                            Date: "2008-08-18",
                            Type: Type,
                        },
                        success: function (result) {
                            if (result != null) {
                                //morning

                                START_TIME = convertJsonDateTime(result.StartTimeDay);
                                END_TIME = convertJsonDateTime(result.EndTimeDay);
                                //9Hole
                                DAY_9HOLE = convertJsonDateTime(result.Day9Hole);
                                NIGHT_9HOLE = convertJsonDateTime(result.Nite9Hole);
                                //Interval
                                INTERVAL = result.Interval;
                                //end

                                var elapsed;
                                elapsed = END_TIME - START_TIME;

                                totalpopulate = (elapsed / (INTERVAL * 60000));

                                //check Avaibility

                                $.ajax({
                                    url: ServerEndpointAPI + 'api/TimeSlot/OccupiedSlots',
                                    type: 'GET',
                                    dataType: 'json',
                                    data: {
                                        CourseCode: "EST2",
                                        Date: "2008-08-18"
                                    },
                                    success: function (result) {
                                        $.each(result, function (index, element) {
                                            BookedData[index] = convertJsonDateTime(element.TimeSlotTime);
                                            GenerateDropdownList();
                                        });
                                    }
                                });



                            } else {
                                alert("nodata");
                            }

                        },
                        error: function () {
                            alert('error');
                        },
                    });


                });

                function GenerateDropdownList() {

                    var RadioButtonDiv = "";
                    for (var i = 0; i <= totalpopulate; i++) {
                        var IntervalTime = i * INTERVAL;
                        var timeslot = addMinutes(START_TIME, IntervalTime)
                        var timeslotid = timeslot.getHours() + ":" + timeslot.getMinutes() + ":" + timeslot.getSeconds() + "." + timeslot.getMilliseconds(2);
                        for (var p = 0 ; p < BookedData.length ; p++) {
                            if (timeslot.getTime() == BookedData[p].getTime()) {
                                RadioButtonDiv = RadioButtonDiv + " <option value=" + timeslotid + " status='Booked'>" + formatAMPM(timeslot) + "</option>";
                            }
                            else {
                                RadioButtonDiv = RadioButtonDiv + " <option value=" + timeslotid + " status='null' >" + formatAMPM(timeslot) + "</option>";
                            }
                        }
                        //RadioButtonDiv = RadioButtonDiv + "<input type='radio' name='timeslotBooking' id='' value='" + timeslotid + "' onchange='checkHole()'/>" + formatAMPM(timeslot) + "";
                    }
                    $("#timeDropDownList").html("");
                    $("#timeDropDownList").append(RadioButtonDiv);
                }
                function formatAMPM(date) {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    var ampm = hours >= 12 ? 'pm' : 'am';
                    var hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    minutes = minutes < 10 ? '0' + minutes : minutes;
                    strTime = hours + ':' + minutes + ' ' + ampm;
                    return strTime;
                }
                function addMinutes(date, minutes) {
                    return new Date(date.getTime() + minutes * 60000);
                }
                function convertJsonDateTime(data) {
                    var dateString = data;
                    var reggie = /(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/;
                    var dateArray = reggie.exec(dateString);
                    var dateObject = new Date(
                        (+dateArray[1]),
                        (+dateArray[2]) - 1, // Careful, month starts at 0!
                        (+dateArray[3]),
                        (+dateArray[4]),
                        (+dateArray[5]),
                        (+dateArray[6])
                    );
                    return dateObject;
                }
                $('#ShowBookedTimeMessage').hide();


            });
            function check9Hole() {


                //alert(NIGHT_9HOLE);
                //alert(selectedDateTime);
                //if (selectedDateTime.getTime() > NIGHT_9HOLE.getTime())
                //{
                //    alert("9hole");
                //    $("#radio-choice-21").removeAttr("checked");
                //    $("#radio-choice-21").prop('disabled', true);
                //    $("#radio-choice-22").prop('checked', true);
                //    $("input[type='radio']").checkboxradio("refresh");
                //}
                //else {
                //    $("#radio-choice-22").removeAttr("checked");
                //    $("#radio-choice-22").removeAttr('disabled');
                //    $("#radio-choice-21").removeAttr("checked");
                //    $("#radio-choice-21").removeAttr('disabled');
                //    $("#radio-choice-21").prop('checked', true);
                //    $("input[type='radio']").checkboxradio("refresh");
                //}

            }
            $(function () {
                $("#timeDropDownList").change(function () {
                    var element = $('option:selected', this).attr('status');
                    TimeSelected = $('option:selected', this).attr('value');
                    var selectedDateTime = new Date(DateSelected + " " + TimeSelected);

                    if (selectedDateTime.getTime() > NIGHT_9HOLE.getTime() && selectedDateTime.getTime() < END_TIME.getTime()) {
                        alert("9hole");
                        $("#radio-choice-21").removeAttr("checked");
                        $("#radio-choice-21").prop('disabled', true);
                        $("#radio-choice-22").prop('checked', true);
                        $("input[type='radio']").checkboxradio("refresh");
                    }
                    else {
                        $("#radio-choice-22").removeAttr("checked");
                        $("#radio-choice-22").removeAttr('disabled');
                        $("#radio-choice-21").removeAttr("checked");
                        $("#radio-choice-21").removeAttr('disabled');
                        $("#radio-choice-21").prop('checked', true);
                        $("input[type='radio']").checkboxradio("refresh");
                    }
                    if (element == "Booked") {
                        $('#ShowBookedTimeMessage').show();
                        $('#SubmitBooking').hide();
                        $("#radio-choice-22").removeAttr("checked")
                        $("#radio-choice-21").removeAttr("checked")
                        $("#radio-choice-21").prop('disabled', true);
                        $("#radio-choice-22").prop('disabled', true);
                        $("input[type='radio']").checkboxradio("refresh");

                    }
                    else {
                        $('#SubmitBooking').show();
                        $('#ShowBookedTimeMessage').hide();
                        $("#radio-choice-22").removeAttr("checked");
                        $("#radio-choice-22").removeAttr('disabled');
                        $("#radio-choice-21").removeAttr("checked");
                        $("#radio-choice-21").removeAttr('disabled');
                        $("#radio-choice-21").prop('checked', true);
                        $("input[type='radio']").checkboxradio("refresh");
                    }
                });
            });
            function submitBooking() {
                HoleSelected = $("#NumberofHole :radio:checked").val();
                var Validate = $("#timeDropDownList").val();
                var clubMemberID = "1";
                var clubMemberNo = "";
                if (localStorage.getItem("ClubMemberID") != null) {
                    clubMemberID = localStorage.getItem("ClubMemberID");
                }
                if (localStorage.getItem("MembershipNo") != null) {
                    clubMemberID = localStorage.getItem("MembershipNo");
                }

                $.ajax({
                    url: ServerEndpointAPI + 'api/Booking/Book',
                    type: 'GET',
                    async: false,
                    data: {
                        Date: DateSelected + " " + TimeSelected,
                        CourseCode: "EST2",
                        MembershipNo: clubMemberNo,
                        HoleType: HoleSelected,
                        ClubmemberID: clubMemberID,
                    },
                    success: function (result) {
                        if (result != 0) {
                            var bookingid = result;
                            //$.mobile.changePage("bookingConfirmed.html", { data: { "BookingID": bookingid } });
                            alert("Booking Successful");
                            $("#SubmitBooking").prop('href', 'bookingConfirmed.html?BookingID=' + bookingid);
                            return true;
                        } else {
                            return false;
                        }
                    },
                    error: function () {
                        alert("Error");
                    }
                });
            }

        </script>


        <!-- portBox Content -->
        <div data-role="popup" id="popup_Booking" data-position-to="window">

            <!--            <div data-theme="d" data-role="none" class="header ui-header ui-bar-a" id="smallerFont">
                 <div data-role="content">
                <h3 style="text-align: center">TROPICANA GOLF</h3>
                     </div>
            </div>-->
            <ul data-role="listview" data-theme="d" data-inset="true">
                <li data-theme="g" class="center">
                    <id id="Inside-Club"></id>
                </li>
                <li class="center">

                    <table align="center">
                        <tbody>
                            <tr>
                                <th>
                                    <img src="images/course2.png" class="dialogLogo" /><br />
                                </th>
                                <th>
                                    <id id="Inside-Course"></id>
                                </th>
                            </tr>
                            <tr>
                                <th></th>
                                <th></th>
                            </tr>
                            <tr>
                                <th>
                                    <img src="images/date2.png" class="dialogLogo" /><br />
                                </th>
                                <th class="btnLeft">
                                    <id id="Inside-DateTime"></id>
                                </th>
                            </tr>
                            <tr>
                                <th>
                                    <img src="images/time.png" class="dialogLogo" /><br />
                                </th>
                                <th>

                                    <select data-native-menu="false" data-theme="d" id="timeDropDownList" onchange="check9Hole();">
                                        <option>Time</option>
                                    </select>
                                    <div id="ShowBookedTimeMessage">
                                        <p style="color: red">*The Time is not available.<br />
                                            Please Choose Another Time</p>
                                    </div>
                                </th>
                            </tr>

                        </tbody>
                    </table>
                    <id>Number of Hole</id>
                    <div id="numberofHole">

                        <fieldset data-role="controlgroup" data-type="horizontal" id="NumberofHole">
                            <input type="radio" name="NumberofHole" id="radio-choice-21" value="18" checked="checked" />
                            <label for="radio-choice-21">18</label>

                            <input type="radio" name="NumberofHole" id="radio-choice-22" value="9" />
                            <label for="radio-choice-22">9</label>
                        </fieldset>
                    </div>
                    <br>

                    <div>
                        <!--href="bookingConfirmed.html" -->
                        <a id="SubmitBooking" data-role="button" data-mini="true" data-transition="flow" data-theme="g" onclick=" return submitBooking();">OK
                        </a>
                        <a data-role="button" href="booking.html" data-mini="true" data-transition="fade" data-theme="g">Cancel
                        </a>

                    </div>
                </li>
            </ul>
        </div>
    </div>
</body>
</html>

